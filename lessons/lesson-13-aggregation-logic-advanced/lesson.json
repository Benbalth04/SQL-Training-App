{
    "lesson-id": "lesson-13-aggregation-logic-advanced",
    "title": "Lesson 13",
    "subtitle": "Advanced Aggregation Logic",
    "lesson-order": 13,
    "database-tables": [
        {
            "name": "Countries",
            "priority": 1
        },
        {
            "name": "Cities",
            "priority": 2
        }
    ],
    "exercise-tasks": [
        {
            "task-id": 13.1,
            "description": "Count the number of countries with a population over 100 million using a conditional aggregate",
            "correct-query": "SELECT COUNT(CASE WHEN Population > 100000000 THEN 1 END) AS LargeCountries\nFROM Countries",
            "verify-query": "SELECT COUNT(CASE WHEN Population > 100000000 THEN 1 END) AS LargeCountries FROM Countries",
            "order-sensitive": false,
            "exercise-order": 1,
            "initial-query": "SELECT * FROM Countries",
            "large-query": false,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly counts the number of countries with a population over 100 million using a conditional aggregate. How does the CASE statement work inside the COUNT function? Why does COUNT only include rows where the CASE expression evaluates to 1? How is this different from using a WHERE clause?\n\nCorrect query:\nSELECT COUNT(CASE WHEN Population > 100000000 THEN 1 END) AS LargeCountries\nFROM Countries"
        },
        {
            "task-id": 13.2,
            "description": "Calculate total and average population per region",
            "correct-query": "SELECT\n  Region,\n  SUM(Population) AS TotalPopulation,\n  AVG(Population) AS AvgCountryPopulation\nFROM Countries\nGROUP BY Region",
            "verify-query": "SELECT Region, SUM(Population) AS TotalPopulation, AVG(Population) AS AvgCountryPopulation FROM Countries GROUP BY Region",
            "order-sensitive": false,
            "exercise-order": 2,
            "initial-query": "SELECT * FROM Countries",
            "large-query": false,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly calculates the total and average population per region. How do the SUM and AVG aggregate functions operate on grouped data? Why is the GROUP BY clause necessary? How does the query ensure that each region gets a single row with the calculated totals and averages?\n\nCorrect query:\nSELECT\n  Region,\n  SUM(Population) AS TotalPopulation,\n  AVG(Population) AS AvgCountryPopulation\nFROM Countries\nGROUP BY Region"
        },
        {
            "task-id": 13.3,
            "description": "List countries with the number of cities each has",
            "correct-query": "SELECT\n  co.Name,\n  COUNT(ci.CityID) AS NumCities\nFROM Countries co\nLEFT JOIN Cities ci ON co.CountryID = ci.CountryID\nGROUP BY co.Name",
            "verify-query": "SELECT co.Name, COUNT(ci.CityID) AS NumCities FROM Countries co LEFT JOIN Cities ci ON co.CountryID = ci.CountryID GROUP BY co.Name",
            "order-sensitive": false,
            "exercise-order": 3,
            "initial-query": "SELECT * FROM Countries",
            "large-query": false,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly lists countries along with the number of cities they have. How does the LEFT JOIN ensure countries with zero cities are included? How does COUNT(ci.CityID) work in combination with the join? Why is GROUP BY co.Name necessary for the aggregation?\n\nCorrect query:\nSELECT\n  co.Name,\n  COUNT(ci.CityID) AS NumCities\nFROM Countries co\nLEFT JOIN Cities ci ON co.CountryID = ci.CountryID\nGROUP BY co.Name"
        },
        {
            "task-id": 13.4,
            "description": "Count, for each region, how many cities have populations greater than 5 million",
            "correct-query": "SELECT\n  co.Region,\n  COUNT(ci.CityID) AS LargeCities\nFROM Countries co\nLEFT JOIN Cities ci ON co.CountryID = ci.CountryID AND ci.Population > 5000000\nGROUP BY co.Region",
            "verify-query": "SELECT co.Region, COUNT(ci.CityID) AS LargeCities FROM Countries co LEFT JOIN Cities ci ON co.CountryID = ci.CountryID AND ci.Population > 5000000 GROUP BY co.Region",
            "order-sensitive": false,
            "exercise-order": 4,
            "initial-query": "SELECT * FROM Countries",
            "large-query": false,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly counts, for each region, how many cities have populations greater than 5 million. How does adding a condition to the LEFT JOIN filter the cities included in the COUNT? How does GROUP BY co.Region aggregate the results per region? Why is the conditional join approach used instead of a WHERE clause?\n\nCorrect query:\nSELECT\n  co.Region,\n  COUNT(ci.CityID) AS LargeCities\nFROM Countries co\nLEFT JOIN Cities ci ON co.CountryID = ci.CountryID AND ci.Population > 5000000\nGROUP BY co.Region"
        }
    ]
}
