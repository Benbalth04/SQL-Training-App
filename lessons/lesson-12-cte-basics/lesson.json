{
    "lesson-id": "lesson-12-cte-basics",
    "title": "Lesson 12",
    "subtitle": "Common Table Expressions (CTEs)",
    "lesson-order": 12,
    "database-tables": [
        {
            "name": "Countries",
            "priority": 1
        }
    ],
    "exercise-tasks": [
        {
            "task-id": 12.1,
            "description": "Create a CTE to calculate the average population of all countries",
            "correct-query": "WITH AvgPopulation AS (\n  SELECT AVG(Population) AS AvgPop FROM Countries\n)\n\nSELECT * FROM AvgPopulation",
            "verify-query": "WITH AvgPopulation AS (SELECT AVG(Population) AS AvgPop FROM Countries) SELECT * FROM AvgPopulation",
            "order-sensitive": false,
            "exercise-order": 1,
            "initial-query": "SELECT * FROM Countries",
            "large-query": false,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly calculates the average population using a Common Table Expression (CTE). How does the WITH clause define the CTE? How is the inner SELECT used in the CTE, and how does the outer SELECT retrieve results from it? Why might using a CTE be preferable to a subquery in this case?\n\nCorrect query:\nWITH AvgPopulation AS (\n  SELECT AVG(Population) AS AvgPop FROM Countries\n)\n\nSELECT * FROM AvgPopulation"
        },
        {
            "task-id": 12.2,
            "description": "Use a CTE to list countries with a population above the average",
            "correct-query": "WITH AvgPopulation AS (\n  SELECT AVG(Population) AS AvgPop FROM Countries\n)\n\nSELECT Name, Population\nFROM Countries, AvgPopulation\nWHERE Population > AvgPopulation.AvgPop",
            "verify-query": "WITH AvgPopulation AS (SELECT AVG(Population) AS AvgPop FROM Countries) SELECT Name, Population FROM Countries, AvgPopulation WHERE Population > AvgPopulation.AvgPop",
            "order-sensitive": false,
            "exercise-order": 2,
            "initial-query": "SELECT * FROM Countries",
            "large-query": false,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly lists countries with population above the average using a CTE. How does the CTE AvgPopulation supply the average to the outer query? Why is it necessary to reference AvgPopulation.AvgPop in the WHERE clause? How does combining the CTE with the main table in the FROM clause allow this comparison?\n\nCorrect query:\nWITH AvgPopulation AS (\n  SELECT AVG(Population) AS AvgPop FROM Countries\n)\n\nSELECT Name, Population\nFROM Countries, AvgPopulation\nWHERE Population > AvgPopulation.AvgPop"
        },
        {
            "task-id": 12.3,
            "description": "Chain two CTEs: first calculate total population, then find countries with population above average",
            "correct-query": "WITH TotalPopulation AS (\n  SELECT SUM(Population) AS TotalPop FROM Countries\n),\n\nAboveAverage AS (\n  SELECT Name, Population FROM Countries\n  WHERE Population > (\n    SELECT TotalPop/COUNT(*) FROM TotalPopulation\n  )\n)\n\nSELECT * FROM AboveAverage",
            "verify-query": "WITH TotalPopulation AS (SELECT SUM(Population) AS TotalPop FROM Countries), AboveAverage AS (SELECT Name, Population FROM Countries WHERE Population > (SELECT TotalPop/COUNT(*) FROM TotalPopulation)) SELECT * FROM AboveAverage",
            "order-sensitive": false,
            "exercise-order": 3,
            "initial-query": "SELECT * FROM Countries",
            "large-query": true,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly chains two CTEs to first calculate total population and then find countries with population above average. How does TotalPopulation compute the total sum? How does AboveAverage reference TotalPopulation to calculate the average? Why is chaining CTEs useful for breaking down complex queries into steps? How does the outer SELECT retrieve results from the second CTE?\n\nCorrect query:\nWITH TotalPopulation AS (\n  SELECT SUM(Population) AS TotalPop FROM Countries\n),\n\nAboveAverage AS (\n  SELECT Name, Population FROM Countries\n  WHERE Population > (\n    SELECT TotalPop/COUNT(*) FROM TotalPopulation\n  )\n)\n\nSELECT * FROM AboveAverage"
        },
        {
            "task-id": 12.4,
            "description": "Create a CTE to list countries sorted by population and display only the top 3 most populous countries",
            "correct-query": "WITH RankedCountries AS\n  (SELECT Name, Population FROM Countries\n   ORDER BY Population DESC\n )\n\nSELECT Name, Population FROM RankedCountries\nLIMIT 3",
            "verify-query": "WITH RankedCountries AS(SELECT Name, Population FROM Countries ORDER BY Population DESC) SELECT Name, Population FROM RankedCountries LIMIT 3",
            "order-sensitive": false,
            "exercise-order": 4,
            "initial-query": "SELECT * FROM Countries",
            "large-query": false,
            "allow-dml": false,
            "create-tables": false,
            "preview-allowed": true,
            "chatgpt-prompt": "Explain why this SQL query correctly uses a CTE to rank countries by population and retrieve the top 3. How does the ORDER BY inside the CTE organize the rows? How does the outer SELECT with LIMIT retrieve only the top 3 records? Why might using a CTE be more readable than writing the ORDER BY and LIMIT directly in a single query?\n\nCorrect query:\nWITH RankedCountries AS\n  (SELECT Name, Population FROM Countries\n   ORDER BY Population DESC\n )\n\nSELECT Name, Population FROM RankedCountries\nLIMIT 3"
        }
    ]
}
